# 活動統計儀表板

這是一個使用 React + Material UI 建立的活動統計儀表板，可以上傳 Excel 檔案並產生各種統計圖表。

## 功能特色

- 📊 上傳 Excel 檔案並自動解析資料（支援人力需求表和時數登錄表）
- 📅 支援多種日期格式自動解析（包括日期範圍和中文括號）
- 🎯 自動過濾取消的活動和 2025 年以外的日期
- 👥 支援人名別名映射，自動合併相同人員的不同寫法
- 📈 產生 22 種不同的統計圖表（根據上傳的檔案類型動態顯示）
- 🎨 統一的顏色配置和排序邏輯

## 安裝與執行

### 安裝依賴

```bash
npm install
```

### 開發模式

```bash
npm run dev
```

### 建置生產版本

```bash
npm run build
```

### 預覽生產版本

```bash
npm run preview
```

## 使用說明

### 上傳檔案

系統支援兩種 Excel 檔案：

1. **人力需求表**：上傳後會顯示圖表 1-20
   - 必須包含名為「2025」的工作表
   - 系統會自動讀取並解析資料

2. **時數登錄表**：上傳後會顯示圖表 21
   - 必須包含名為「表單回應」的工作表
   - 系統會自動讀取並解析資料

3. **同時上傳兩個檔案**：會顯示圖表 1-22（包含差值統計圖表）

### 圖表顯示規則

- **只上傳人力需求表** → 顯示圖表 1-20
- **只上傳時數登錄表** → 顯示圖表 21
- **兩個都有上傳** → 顯示圖表 1-22

## 統計圖表說明

### 依活動類型統計（圖表 1-4）

1. **各月份活動次數統計（依活動類型）** - Stack 柱狀圖
2. **各月份活動天數統計（依活動類型）** - Stack 柱狀圖
3. **依活動類型統計次數** - 圓餅圖（左），標題顯示總次數
4. **依活動類型統計天數** - 圓餅圖（右），標題顯示總天數

### 依縣市統計（圖表 5-8）

5. **各月份活動次數統計（依縣市）** - Stack 柱狀圖
6. **各月份活動天數統計（依縣市）** - Stack 柱狀圖
7. **依縣市統計次數** - 圓餅圖（左），標題顯示總次數
8. **依縣市統計天數** - 圓餅圖（右），標題顯示總天數

- 縣市排序：按照北中南東的順序排列，未分類放在最後
- 圖例順序：與柱狀圖一致，按北中南東排列

### 依地區統計（圖表 9-12）

9. **各月份活動次數統計（依地區）** - Stack 柱狀圖
10. **各月份活動天數統計（依地區）** - Stack 柱狀圖
11. **依地區統計次數** - 圓餅圖（左），標題顯示總次數
12. **依地區統計天數** - 圓餅圖（右），標題顯示總天數

- 地區分類：北部、中部、南部、東部、未分類
- 顏色配置：北部（藍紫色）、中部（綠色）、南部（黃色）、東部（橙色）、未分類（灰色）

### 志工人數統計（圖表 13-18）- 需要人力需求表

13. **志工人數統計（依月份）** - Stack 柱狀圖，使用活動類型作 stack
14. **志工人數統計（依縣市）** - Stack 柱狀圖，使用活動類型作 stack，縣市順序和顏色與圖表 5 一致
15. **志工人數統計（依地區）** - Stack 柱狀圖，使用活動類型作 stack，地區順序和顏色與圖表 10 一致
16. **志工人數統計（依活動類型）** - 圓餅圖（左），標題顯示總人數
17. **志工人數統計（依地區）** - 圓餅圖（中），標題顯示總人數
18. **志工人數統計（依縣市）** - 圓餅圖（右），標題顯示總人數

- 志工人數計算：人數 × 天數（如果天數 < 1，則使用 1）
- 顏色配置：與圖表 1 的活動類型顏色一致

### 出勤活動統計（圖表 19-20）- 需要人力需求表

19. **出勤活動次數統計** - Stack 柱狀圖，使用活動類型作 stack，分成上下兩部分
20. **出勤活動時數統計** - Stack 柱狀圖，使用活動類型作 stack，分成上下兩部分

- 人名會使用別名映射自動合併
- 使用活動類型作 stack，顏色與圖表 1 一致
- 當人名過多時，會自動分成上下兩個圖表顯示，方便閱讀

### 回報時數統計（圖表 21）- 需要時數登錄表

21. **回報時數統計** - Stack 柱狀圖，依參與內容分類，分成上下兩部分

- 使用時數登錄表的資料
- 依參與內容（reportType）分類統計
- 當志工過多時，會自動分成上下兩個圖表顯示

### 差值統計（圖表 22）- 需要兩個檔案

22. **出勤手作時數 - 回報步道實作帶領時數** - 柱狀圖，顯示差值

- 計算：圖表 20 中的「手作」時數 - 圖表 21 中的「步道實作帶領」時數
- 正數顯示為藍色，負數顯示為紅色
- 當志工過多時，會自動分成上下兩個圖表顯示

## Excel 檔案格式要求

### 人力需求表

- 必須包含名為「2025」的工作表
- 欄位位置：
  - **A 欄**：日期（支援多種格式，見下方說明）
  - **B 欄**：活動名稱
  - **C 欄**：辦理情形（包含「取消」的活動會被自動過濾）
  - **D 欄**：天數
  - **E 欄**：活動類型
  - **G 欄**：縣市
  - **L 欄**：志工人數
  - **N 欄**：可登錄時數
  - **Q 欄**：服勤區（人名，支援多種分隔符）

### 時數登錄表

- 必須包含名為「表單回應」的工作表
- 欄位位置：
  - **B 欄**：志工姓名
  - **C 欄**：日期（只解析 2025 年的日期）
  - **D 欄**：參與內容
  - **F 欄**：參與時數

### 日期格式支援

系統支援以下日期格式（**只解析 2025 年的日期**）：

#### 人力需求表日期格式

- 單一日期：`1/3`、`11/21` → 解析為 2025/1/3、2025/11/21
- 日期範圍：`1/3-5` → 2025/1/3 至 2025/1/5（使用開始日期統計）
- 日期範圍：`11/21-11/25` → 2025/11/21 至 2025/11/25
- 包含星期：`11/9（日）`、`1/3(一)` → 自動移除括號內容

#### 時數登錄表日期格式

- 系統會自動檢查日期是否為 2025 年
- 如果不是 2025 年開頭的日期（如 `20220305-06`、`2016／11／05`），會自動跳過，不進行解析
- 支援多種日期格式，但只處理 2025 年的資料

### 服勤區人名格式

服勤區欄位支援以下格式：

#### 基本格式

支援以下分隔符：
- 頓號：`張三、李四、王五`
- 中文逗號：`張三，李四，王五`
- 英文逗號：`張三,李四,王五`
- 換行符：多行分隔

#### 名字後面的日期格式

支援在名字後面加上日期，用於指定該人員參與的特定日期：
- `建宇(8/23)` → 建宇在 8/23 參與，時數 = 8 小時
- `建宇(21-22)` → 建宇在 21-22 日參與（使用活動日期確定月份），時數 = 16 小時
- `建宇(7/22-23)` → 建宇在 7/22-23 參與，時數 = 16 小時
- `建宇(6/30-7/1)` → 建宇在 6/30-7/1 參與（跨月），時數 = 16 小時

**注意**：
- 次數統計：無論名字中是否有日期，每個活動記錄中的每個參與人員都只算 1 次
- 時數統計：如果名字中有日期，時數 = 天數 × 8 小時；否則使用記錄中的可登錄時數
- 支援中文括號（`（` `）`）和英文括號（`(` `)`）

#### 日期前綴格式

支援在行首使用日期前綴，指定該日期範圍內的所有人員：
- `11/29-30：盈瑩、藝婷、歸真` → 盈瑩、藝婷、歸真在 11/29-30 參與，每人時數 = 16 小時
- `11/29：武治、岱華、沛彣` → 武治、岱華、沛彣在 11/29 參與，每人時數 = 8 小時
- `11/30：宏構` → 宏構在 11/30 參與，時數 = 8 小時

**格式說明**：
- 日期前綴格式：`日期範圍：人名列表`
- 支援中文冒號（`：`）和英文冒號（`:`）
- 日期範圍可以是單一日期（`11/29`）或日期範圍（`11/29-30`、`6/30-7/1`）
- 人名列表支援頓號、中文逗號、英文逗號分隔
- 可以混合使用多行，每行可以有不同的日期前綴

**範例**：
```
11/29-30：盈瑩、藝婷、歸真、怡儒、玲媛、珮雯、彥輝、秀慈、佳鈴、正雄、素珍、豪萱、聖軒
11/29：武治、岱華、沛彣
11/30：宏構
```

## 人名別名映射

系統支援人名別名映射功能，可以將相同人員的不同寫法合併統計。

### 設定別名

1. 執行 `node extractNames.js` 提取所有人名
2. 編輯 `nameAliases.json` 檔案
3. 將相同人員的別名設定為相同的標準名稱

**重要**：
- 名字後面有日期的格式（如 `建宇(8/23)`）**不需要**在別名映射中設定
- 系統會自動提取真實名字（去掉括號部分）並進行別名映射
- 日期前綴格式（如 `11/29-30：盈瑩`）也不需要設定，系統會自動處理

例如：
```json
{
  "Lingo": "宏構",
  "lingo": "宏構",
  "陳宏構": "宏構",
  "建宇": "建宇"
}
```

**不需要設定**：
- `建宇(8/23)` → 系統會自動提取為 `建宇`
- `11/29-30：盈瑩` → 系統會自動提取為 `盈瑩`

### 提取人名腳本

```bash
node extractNames.js
```

此腳本會：
- 讀取 Excel 檔案中的服勤區欄位
- 提取所有不重複的人名
- 生成 `nameAliases.json` 檔案供編輯

## 技術棧

- **React 18** - UI 框架
- **Material UI 5** - UI 元件庫
- **Recharts** - 圖表庫
- **ExcelJS** - Excel 檔案解析
- **Vite** - 建置工具

## 專案結構

```
activityStatistics/
├── src/
│   ├── components/
│   │   ├── ExcelUploader.jsx      # Excel 上傳元件
│   │   └── StatisticsCharts.jsx   # 統計圖表元件
│   ├── utils/
│   │   ├── dateParser.js          # 日期解析工具
│   │   ├── excelParser.js         # 人力需求表解析工具
│   │   ├── hourLogParser.js       # 時數登錄表解析工具
│   │   ├── hourLogProcessor.js    # 時數登錄表資料處理
│   │   ├── dataProcessor.js       # 資料處理和統計計算
│   │   └── nameAliases.js         # 人名別名映射工具
│   ├── App.jsx                    # 主應用元件
│   └── main.jsx                   # 應用入口
├── nameAliases.json               # 人名別名映射設定檔
├── reportType.js                  # 參與內容類型定義
├── extractNames.js                # 人名提取腳本
└── package.json
```

## 注意事項

### 資料處理

- 日期預設年份為 2025 年
- **時數登錄表只解析 2025 年的日期**，其他年份的日期會自動跳過
- 辦理情形包含「取消」的活動會被自動過濾
- 縣市和地區的排序遵循：北部 → 中部 → 南部 → 東部 → 未分類
- 人名統計會自動使用別名映射合併相同人員

### 志工人數計算

- 志工人數 = 人數 × 天數
- **如果天數 < 1（如 0.5 天），則使用 1 天計算**

### 圖表顯示

- **圓餅圖標題會自動顯示總次數、總天數或總人數**
- **圖表會根據上傳的檔案類型動態顯示**：
  - 只上傳人力需求表 → 顯示圖表 1-20
  - 只上傳時數登錄表 → 顯示圖表 21
  - 兩個都有上傳 → 顯示圖表 1-22
- 當參與人員過多時，圖表會自動分成上下兩部分顯示

### 人名格式

- **名字後面的日期格式會自動解析，用於計算時數，不影響次數統計**
- **日期前綴格式會自動解析，優先於名字後面的日期格式**
- 名字後面有日期的格式（如 `建宇(8/23)`）不需要在別名映射中設定
- 日期前綴格式（如 `11/29-30：盈瑩`）也不需要設定，系統會自動處理

### 錯誤處理

- 如果解析過程中出現錯誤，會在瀏覽器控制台顯示錯誤訊息
- 無法解析的日期會自動跳過，不會中斷整個解析過程

